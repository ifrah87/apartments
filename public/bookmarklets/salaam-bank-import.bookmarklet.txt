javascript:(()=>{const p="https://YOUR-PROD-APP-ORIGIN",b=location.host.includes("salaambank.so"),o=b?p:location.origin;if(!o||o.includes("YOUR-PROD-APP-ORIGIN")){alert("Please set PROD_ORIGIN in the bookmarklet before running.");return}const h=t=>String(t||"").toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9]/g,""),d=t=>{const m=String(t||"").match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(!m)return null;return`${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`},n=t=>{const c=String(t||"").replace(/,/g,"").replace(/\s+/g,"").replace(/[^0-9.-]/g,"");if(!c||c==="-")return 0;const v=Number(c);return Number.isFinite(v)?v:0},f=()=>{const t=[...document.querySelectorAll("table")],e=["date","ref","branch","particulars","chequeno","withdrawal","deposit","balance"];for(const r of t){const s=[...r.querySelectorAll("tr")];if(!s.length)continue;const a=s.find(x=>x.querySelectorAll("th").length>0)||s[0],c=[...a.querySelectorAll("th, td")].map(x=>h(x.textContent)),m=e.filter(k=>c.includes(k));if(m.length>=5&&c.includes("date")&&c.includes("balance"))return{table:r,headers:c,headerRow:a}}return null},g=()=>{const s=["#Account","#account","[name*=Account]","[id*=Account]","[name*=account]"];for(const q of s){const el=document.querySelector(q);if(!el)continue;if("value"in el&&String(el.value).trim())return String(el.value).trim();if(el.textContent&&el.textContent.trim())return el.textContent.trim()}return null},st=f();if(!st){alert("Could not find the statement table on this page.");return}const rows=[...st.table.querySelectorAll("tr")],hi=rows.indexOf(st.headerRow),dataRows=rows.slice(hi+1),tx=[];for(const r of dataRows){const cells=[...r.querySelectorAll("td")];if(!cells.length)continue;const vals=cells.map(c=>c.textContent?.trim()??""),row={};st.headers.forEach((k,i)=>{row[k]=vals[i]??""});const date=d(row.date);if(!date)continue;tx.push({date,ref:row.ref||null,branch:row.branch||null,particulars:row.particulars||null,chequeNo:row.chequeno||null,withdrawal:n(row.withdrawal),deposit:n(row.deposit),balance:n(row.balance)})}if(!tx.length){alert("No transactions found to import.");return}const payload={source:"bookmarklet",pageUrl:location.href,account:g()||undefined,transactions:tx};fetch(`${o}/api/banking/bookmarklet`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(payload)}).then(async res=>{const data=await res.json().catch(()=>({}));if(!res.ok){throw new Error(data?.error||"Import failed.")}return data}).then(data=>{alert(`Imported ${data.imported}, skipped ${data.skipped}`)}).catch(err=>{alert(`Import failed: ${err.message}`)})})();
